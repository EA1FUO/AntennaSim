FROM python:3.12-slim

RUN apt-get update && \
    apt-get install -y --no-install-recommends nec2c && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

RUN which nec2c

WORKDIR /app

COPY pyproject.toml ./

# Install dependencies directly with pip for dev simplicity
RUN pip install --no-cache-dir \
    "fastapi>=0.115.0" \
    "uvicorn[standard]>=0.32.0" \
    "pydantic>=2.10.0" \
    "pydantic-settings>=2.6.0" \
    "redis>=5.2.0" \
    "httpx>=0.28.0"

COPY src/ ./src/

ENV NEC_WORKDIR=/tmp/nec_workdir
ENV PYTHONUNBUFFERED=1

RUN mkdir -p /tmp/nec_workdir

EXPOSE 8000
CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
