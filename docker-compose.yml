services:
  frontend:
    image: ea1fuo/antennasim-frontend:latest
    build:
      context: .
      dockerfile: frontend/Dockerfile

  backend:
    image: ea1fuo/antennasim-backend:latest
    build:
      context: .
      dockerfile: backend/Dockerfile
    environment:
      - ENVIRONMENT=production
      - ALLOWED_ORIGINS=https://antsim.app,https://www.antsim.app,http://localhost,http://localhost:80
      - REDIS_URL=redis://redis:6379
      - RATE_LIMIT_ENABLED=false
      - RATE_LIMIT_PER_HOUR=30
      - MAX_CONCURRENT_PER_IP=5
      - SIM_TIMEOUT_SECONDS=180
      - NEC_WORKDIR=/tmp/nec_workdir
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 512M
    read_only: true
    tmpfs:
      - /tmp/nec_workdir:size=100M,uid=999,gid=999
    security_opt:
      - no-new-privileges:true
    depends_on:
      - redis

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    command: redis-server --maxmemory 128mb --maxmemory-policy allkeys-lru
    restart: unless-stopped

  nginx:
    image: ea1fuo/antennasim-nginx:latest
    build: ./nginx
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - frontend
      - backend
    restart: unless-stopped

volumes:
  redis_data:
